"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TUI ç»„ä»¶åº“ - åŸºäºŽ Rich çš„ç•Œé¢å…ƒç´ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è®¾è®¡åŽŸåˆ™ï¼š
  - ç»„ä»¶èŒè´£å•ä¸€ï¼ˆæ¶ˆæ¯/å·¥å…·/çŠ¶æ€å„è‡ªç‹¬ç«‹ï¼‰
  - æ— çŠ¶æ€æ¸²æŸ“ï¼ˆè¾“å…¥æ•°æ® â†’ è¾“å‡ºæ ¼å¼,æ— å‰¯ä½œç”¨ï¼‰
  - è§†è§‰æ¸…æ™°ï¼ˆè¾¹æ¡†/é¢œè‰²/å›¾æ ‡åŒºåˆ†ä¸åŒå†…å®¹ï¼‰
"""

from rich.console import Console
from rich.panel import Panel
from rich.markdown import Markdown
from rich.table import Table
from rich.progress import Progress, SpinnerColumn, TextColumn
from langchain_core.messages import HumanMessage, AIMessage, ToolMessage


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å…¨å±€æŽ§åˆ¶å°å®žä¾‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

console = Console()


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ¶ˆæ¯æ¸²æŸ“å™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def render_message(message) -> None:
    """
    æ¸²æŸ“å•æ¡æ¶ˆæ¯ï¼ˆæ ¹æ®ç±»åž‹è‡ªåŠ¨é€‰æ‹©æ ·å¼ï¼‰

    æ”¯æŒç±»åž‹:
      - HumanMessage: ç”¨æˆ·è¾“å…¥ï¼ˆè“è‰²è¾¹æ¡†ï¼‰
      - AIMessage: AI å“åº”ï¼ˆç»¿è‰²è¾¹æ¡†ï¼‰
      - ToolMessage: å·¥å…·ç»“æžœï¼ˆé»„è‰²è¾¹æ¡†ï¼‰
    """
    # æ¶ˆé™¤ç±»åž‹åˆ¤æ–­çš„ç‰¹æ®Šæƒ…å†µ â†’ ç”¨æ˜ å°„è¡¨
    message_styles = {
        HumanMessage: ("ðŸ‘¤ ç”¨æˆ·", "blue"),
        AIMessage: ("ðŸ¤– åŠ©æ‰‹", "green"),
        ToolMessage: ("ðŸ”§ å·¥å…·", "yellow")
    }

    # èŽ·å–æ ·å¼ï¼ˆé»˜è®¤ç°è‰²ï¼‰
    title, color = message_styles.get(
        type(message),
        ("ðŸ“ æ¶ˆæ¯", "white")
    )

    # æ¸²æŸ“å†…å®¹
    content = message.content if hasattr(message, "content") else str(message)

    # å¦‚æžœæ˜¯ AI æ¶ˆæ¯ä¸”åŒ…å«å·¥å…·è°ƒç”¨,å•ç‹¬æ˜¾ç¤º
    if isinstance(message, AIMessage) and hasattr(message, "tool_calls"):
        tool_calls = message.tool_calls or []
        if tool_calls:
            _render_tool_calls(tool_calls)
            return  # å·¥å…·è°ƒç”¨ä¸æ˜¾ç¤ºæ–‡æœ¬å†…å®¹

    # æ™®é€šæ¶ˆæ¯æ˜¾ç¤º
    if content.strip():
        console.print(
            Panel(
                Markdown(content),
                title=title,
                border_style=color,
                padding=(1, 2)
            )
        )


def _render_tool_calls(tool_calls: list) -> None:
    """æ¸²æŸ“å·¥å…·è°ƒç”¨åˆ—è¡¨ï¼ˆå†…éƒ¨è¾…åŠ©å‡½æ•°ï¼‰"""
    table = Table(title="ðŸ”§ å·¥å…·è°ƒç”¨", border_style="cyan")
    table.add_column("å·¥å…·", style="cyan")
    table.add_column("å‚æ•°", style="white")

    for call in tool_calls:
        tool_name = call.get("name", "æœªçŸ¥")
        args = str(call.get("args", {}))
        table.add_row(tool_name, args)

    console.print(table)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ¬¢è¿Žç•Œé¢
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def render_welcome() -> None:
    """æ˜¾ç¤ºæ¬¢è¿Žç•Œé¢"""
    welcome_text = """
# ðŸš€ TUI Code Agent

ä¸€ä¸ªåŸºäºŽ LangGraph çš„æ™ºèƒ½ä»£ç åŠ©æ‰‹

## å¯ç”¨å‘½ä»¤
- è¾“å…¥ä»»åŠ¡æè¿°,Agent ä¼šè‡ªåŠ¨è°ƒç”¨å·¥å…·å®Œæˆ
- è¾“å…¥ `exit` æˆ– `quit` é€€å‡º

## å¯ç”¨å·¥å…·
- `read_file` - è¯»å–æ–‡ä»¶å†…å®¹
- `write_file` - å†™å…¥æ–‡ä»¶
- `list_files` - åˆ—å‡ºç›®å½•
- `shell` - æ‰§è¡Œ Shell å‘½ä»¤
    """

    console.print(
        Panel(
            Markdown(welcome_text),
            border_style="bold magenta",
            padding=(1, 2)
        )
    )
    console.print()


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# çŠ¶æ€æŒ‡ç¤ºå™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def show_thinking() -> Progress:
    """
    æ˜¾ç¤ºæ€è€ƒä¸­çš„è¿›åº¦æ¡

    è¿”å›ž Progress å¯¹è±¡,è°ƒç”¨è€…è´Ÿè´£ stop()
    """
    progress = Progress(
        SpinnerColumn(),
        TextColumn("[cyan]æ€è€ƒä¸­..."),
        console=console
    )
    progress.start()
    return progress


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åˆ†éš”çº¿
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def render_separator() -> None:
    """æ¸²æŸ“åˆ†éš”çº¿"""
    console.print("â”€" * console.width, style="dim")
